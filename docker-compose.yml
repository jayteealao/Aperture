# Aperture Stack for Portainer GitOps Deployment with Traefik
#
# Usage with Portainer:
# 1. Create stack from Git repository
# 2. Set compose path to: docker-compose.traefik.yml
# 3. Add environment variables in Portainer or create stack.env in repo
# 4. Enable GitOps updates for CI/CD

services:
  # Aperture Gateway (Backend API)
  aperture-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      TZ: ${TZ:-Europe/London}
      PORT: "8080"
      HOST: "0.0.0.0"
      # Enable credential storage (set in stack.env or Portainer env vars)
      CREDENTIALS_MASTER_KEY: ${CREDENTIALS_MASTER_KEY:-}
      APERTURE_API_TOKEN: ${APERTURE_API_TOKEN}
      API_DOMAIN: ${API_DOMAIN}
      WEB_DOMAIN: ${WEB_DOMAIN}
      CROWDSEC_API_KEY: ${CROWDSEC_API_KEY}
      ALLOW_INTERACTIVE_AUTH: ${ALLOW_INTERACTIVE_AUTH:-true}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      MAX_CONCURRENT_SESSIONS: ${MAX_CONCURRENT_SESSIONS:-50}
      MAX_MESSAGE_SIZE_BYTES: ${MAX_MESSAGE_SIZE_BYTES:-262144}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      RPC_REQUEST_TIMEOUT_MS: ${RPC_REQUEST_TIMEOUT_MS:-300000}
      SESSION_IDLE_TIMEOUT_MS: ${SESSION_IDLE_TIMEOUT_MS:-600000}
      CLAUDE_CODE_EXECUTABLE: ${CLAUDE_CODE_EXECUTABLE:-}
      # Database path - use /app/data/db which is created with correct permissions in Dockerfile
      DATABASE_PATH: ${DATABASE_PATH:-/app/data/db/aperture.db}
    volumes:
      # Persist Claude Code home directory for subscription auth
      - claude-data:/home/app/.claude
      # Persist Codex home directory for subscription auth
      - codex-data:/home/app/.codex
      # Persist Gemini CLI home directory for OAuth cache
      - gemini-data:/home/app/.gemini
      # Persist encrypted credentials
      - credentials-data:/home/app/data
    networks: [default]
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/healthz', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      # API routes
      - "traefik.http.routers.aperture-api.rule=Host(`${API_DOMAIN}`)"
      - "traefik.http.routers.aperture-api.entrypoints=web,websecure"
      - "traefik.http.routers.aperture-api.tls=true"
      - "traefik.http.routers.aperture-api.tls.certresolver=myresolver"
      - "traefik.http.services.aperture-api.loadbalancer.server.port=8080"
      # CrowdSec middleware
      - "traefik.http.routers.aperture-api.middlewares=crowdsec-aperture-api@docker"
      - "traefik.http.middlewares.crowdsec-aperture-api.plugin.crowdsec-bouncer.enabled=true"
      - "traefik.http.middlewares.crowdsec-aperture-api.plugin.crowdsec-bouncer.crowdseclapikey=${CROWDSEC_API_KEY}"

  # Aperture Web Frontend
  aperture-web:
    build:
      context: ./web
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      aperture-gateway:
        condition: service_healthy
    environment:
      TZ: ${TZ:-Europe/London}
    networks: [default]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      # Web frontend routes
      - "traefik.http.routers.aperture.rule=Host(`${WEB_DOMAIN}`)"
      - "traefik.http.routers.aperture.entrypoints=web,websecure"
      - "traefik.http.routers.aperture.tls=true"
      - "traefik.http.routers.aperture.tls.certresolver=myresolver"
      - "traefik.http.services.aperture.loadbalancer.server.port=80"
      # CrowdSec middleware
      - "traefik.http.routers.aperture.middlewares=crowdsec-aperture@docker"
      - "traefik.http.middlewares.crowdsec-aperture.plugin.crowdsec-bouncer.enabled=true"
      - "traefik.http.middlewares.crowdsec-aperture.plugin.crowdsec-bouncer.crowdseclapikey=${CROWDSEC_API_KEY}"

networks:
  default:
    name: ${NETWORK_NAME:-traefik_default}
    external: true

volumes:
  claude-data:
    name: aperture-claude-data
  codex-data:
    name: aperture-codex-data
  gemini-data:
    name: aperture-gemini-data
  credentials-data:
    name: aperture-credentials-data
